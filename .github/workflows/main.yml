name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      tag_name:
        type: string
        default: ""
        description: "Optional: the name of the tag to create (e.g. v1.2.3)"

permissions:
  checks: write
  pull-requests: write
  id-token: write
  contents: write     # write so we can push tags
  pages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Optionally create a tag if tag_name was provided in workflow_dispatch
      - name: Create tag
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name != '' }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "Creating tag ${TAG_NAME} on $(git rev-parse HEAD)"
          git tag "${TAG_NAME}"
          git push origin "${TAG_NAME}"
        env:
          TAG_NAME: ${{ inputs.tag_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Set VERSION from the ref:
      # - if this is a tag push or we just created+ pushed a tag, github.ref_type == 'tag'
      # - otherwise fall back to a dev version with short SHA
      - name: Set VERSION
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION="${{ github.ref_name }}"   # e.g. v1.2.3
          elif [ -n "${{ inputs.tag_name }}" ]; then
            VERSION="${{ inputs.tag_name }}"   # manual tag from workflow_dispatch
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi

          echo "VERSION=$VERSION"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Show version
        run: echo "Building version: $VERSION"

      # Github Actions runner already has Node/Yarn; you can pin with actions/setup-node if you want
      - name: Install
        run: yarn

      - name: Unit tests
        run: yarn test

      - name: Build
        run: |
          echo "Building with VERSION=$VERSION"
          VERSION="$VERSION" yarn build

      - name: Integration tests
        run: yarn test:e2e

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          report_paths: 'reports/*.xml'
